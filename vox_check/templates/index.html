<!DOCTYPE html>
<html lang="en">

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/fontawesome-all.min.css" rel="stylesheet">

        <script src="js/wavesurfer.js"></script>
        <script src="js/wavesurfer.timeline.js"></script>
        <script src="js/wavesurfer.regions.js"></script>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row-fluid">
                <div id="waveform"></div>
            </div>
            <div class="row-fluid">
                <div id="timeline"></div>
            </div>
            <div class="row-fluid mt-3">
                <p id="text"></p>
            </div>
            <div class="control-group mt-3">
                <div class="controls row-fluid">
                    <button class="btn btn-success" title="Play" data-action="play">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-primary" title="Pause" data-action="pause">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button class="btn btn-danger" title="Stop" data-action="stop">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="btn btn-secondary ml-3" title="Zoom" data-action="zoom">
                        <i class="fas fa-search"></i>
                    </button>
                    <input id="zoom" type="number" value="200">
                </div>
            </div>
        </div>
        <div class="container ml-2 mr-2">
            <div class="row mt-5">
                <select id="sentences" size="10">
                    {% for fragment in fragments.values(): %}
                    <option value="{{ fragment.id }}">{{ fragment.id }}: {{ fragment.text }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <script>
         var wavesurfer = {};
         var fragments = {};
         var currentFragment = null;

         function q(id) {
             return document.querySelector(id);
         }

         function selectFragment() {
             if (currentFragment == null) {
                 return;
             }

             q('#text').textContent = currentFragment.text;

             let region = Object.values(wavesurfer.regions.list)[0];
             region.update({
                 'start': currentFragment.begin,
                 'end': currentFragment.end
             });

             if (wavesurfer.isReady) {
                 region.play();
             }
         }

         document.addEventListener('DOMContentLoaded', function() {
             {% for fragment in fragments.values(): %}
             fragments['{{ fragment.id }}'] = {
                 'begin': {{ fragment.begin }},
                 'end': {{ fragment.end }},
                 'text': '{{ fragment.text }}'
             }
             {% endfor %}

             wavesurfer = WaveSurfer.create({
                 container: q('#waveform'),
                 height: 200,
                 minPxPerSec: 200,
                 scrollParent: true,
                 waveColor: '#A8DBA8',
                 progressColor: '#3B8686',
                 normalize: true,
                 showTime: true,
                 backend: 'MediaElementWebAudio',
                 plugins: [
                     WaveSurfer.timeline.create({
                         container: '#timeline'
                     }),
                     WaveSurfer.regions.create({
                         regionsMinLength: 0.1,
                         regions: [
                             {
                                 start: 0,
                                 end: 1,
                                 loop: false,
                                 color: 'hsla(400, 100%, 30%, 0.5)'
                             }
                         ],
                         dragSelection: {
                             slop: 5
                         }
                     })
                 ]
             });

             let region = Object.values(wavesurfer.regions.list)[0];
             region.element.children[0].style.width='4px';
             region.element.children[1].style.width='4px';

             wavesurfer.on('region-update-end', function() {
                 if (currentFragment != null) {
                     currentFragment.begin = region.start;
                     currentFragment.end = region.end;
                 }
             })

             wavesurfer.load('media/jordensinre_01_witt_64kb.mp3');

             q('#sentences')
                 .addEventListener('change', function() {
                     var sentences = q('#sentences');
                     if (sentences.selectedIndex >= 0) {
                         var fragId = sentences.options[sentences.selectedIndex].value;
                         currentFragment = fragments[fragId];
                         selectFragment();
                     }
                 })

             currentFragment = fragments[q('#sentences').options[0].value];
             selectFragment();

             q('[data-action="play"]')
                 .addEventListener('click', function() {
                     region.play();
                 });

             q('[data-action="pause"]')
                 .addEventListener('click', function() {
                     wavesurfer.playPause();
                 });

             q('[data-action="stop"]')
                 .addEventListener('click', function() {
                     wavesurfer.stop();
                 });

             q('[data-action="zoom"]')
                 .addEventListener('click', function() {
                     wavesurfer.zoom(q('#zoom').value);
                 });
         });
        </script>
    </body>
</html>
